<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Lyric Perfect</title>
    <style>
        /* [ì´ì „ ì½”ë“œì˜ <style> ë‚´ìš©ì„ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”] */
        /* í¸ì˜ìƒ í•µì‹¬ ìŠ¤íƒ€ì¼ë§Œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤ */
        body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; background: #f7f9fc; }
        .input-box { background: white; padding: 1.5rem; border-radius: 12px; display: flex; flex-direction: column; gap: 1rem; }
        textarea { width: 100%; height: 100px; padding: 10px; }
        button { padding: 10px; background: #4285F4; color: white; border: none; cursor: pointer; border-radius: 8px; }
        .result-container { margin-top: 20px; }
        .line-card { background: white; padding: 1rem; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #34A853; }
        .line-pronunciation { color: #ea4335; font-style: italic; }
        /* ...ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼... */
    </style>
</head>
<body>
    <h1>J-Lyric Web ğŸŒ</h1>
    
    <div class="input-box">
        <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
        <div id="previewContainer" style="display:none;"><img id="imagePreview" style="max-width:100%"></div>
        <textarea id="lyricInput" placeholder="ê°€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <button id="btnTrans" onclick="startTranslate()">ë²ˆì—­í•˜ê¸°</button>
    </div>
    <div id="resultContainer" class="result-container"></div>

    <script>
        let selectedImageBase64 = null;
        let selectedImageMimeType = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                selectedImageBase64 = e.target.result.split(',')[1];
                selectedImageMimeType = file.type;
            };
            reader.readAsDataURL(file);
        }

        async function startTranslate() {
            const lyricText = document.getElementById('lyricInput').value.trim();
            const resultDiv = document.getElementById('resultContainer');
            const btnTrans = document.getElementById('btnTrans');

            if (!lyricText && !selectedImageBase64) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            resultDiv.innerHTML = "ë¶„ì„ ì¤‘...";
            btnTrans.disabled = true;

            try {
                // [í•µì‹¬] API í‚¤ ì—†ì´, ë‚´ ì„œë²„(Vercel)ë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: lyricText,
                        image: selectedImageBase64,
                        mimeType: selectedImageMimeType
                    })
                });

                if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                
                const data = await response.json();
                
                // ê²°ê³¼ ë Œë”ë§ (ì´ì „ê³¼ ë™ì¼)
                resultDiv.innerHTML = "";
                data.forEach(line => {
                    resultDiv.innerHTML += `
                        <div class="line-card">
                            <div>${line.tokens.map(t => `<span onclick="alert('${t.meaning}')" style="cursor:pointer; border-bottom:1px solid #ddd">${t.text}</span>`).join(' ')}</div>
                            <div class="line-pronunciation">[${line.fullPronunciation}]</div>
                            <div>${line.lineTranslation}</div>
                        </div>
                    `;
                });

            } catch (e) {
                alert("ì—ëŸ¬: " + e.message);
            } finally {
                btnTrans.disabled = false;
            }
        }
    </script>
</body>
</html>