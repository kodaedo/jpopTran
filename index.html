<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-Lyric Perfect</title>
    <style>
        /* --- ë””ìì¸ CSS (ë³€ê²½ ì—†ìŒ) --- */
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --highlight: #e8f0fe;
            --bg-color: #f7f9fc;
            --modal-bg: rgba(0, 0, 0, 0.6);
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Apple SD Gothic Neo', sans-serif; }
        body { background-color: var(--bg-color); color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 2rem; }
        
        .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 1.5rem; }
        
        header { text-align: center; margin-bottom: 1rem; }
        h1 { font-size: 2.2rem; margin-bottom: 0.5rem; color: #333; }
        p.subtitle { color: #666; }

        .input-box {
            background: white; padding: 1.5rem; border-radius: 16px;
            box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 1rem;
        }

        .file-upload-wrapper {
            border: 2px dashed #ccc; border-radius: 12px; height: 50px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            background: #f9f9f9; position: relative; font-weight: bold; color: #666; transition: 0.2s;
        }
        .file-upload-wrapper:hover { border-color: var(--primary-color); color: var(--primary-color); background: #e8f0fe; }
        .file-upload-wrapper input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .preview-area { display: none; width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; margin-bottom: 10px; }
        .preview-area img { width: 100%; display: block; }
        .preview-area button { width: 100%; padding: 8px; background: #ff5252; color: white; border: none; cursor: pointer; }

        textarea {
            width: 100%; height: 100px; padding: 1rem; border: 2px solid #eee; border-radius: 12px;
            resize: vertical; outline: none; font-size: 1rem; transition: 0.2s;
        }
        textarea:focus { border-color: var(--primary-color); }

        .main-btn {
            width: 100%; padding: 14px; background-color: var(--primary-color); color: white;
            border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: 0.2s; box-shadow: 0 4px 6px rgba(66, 133, 244, 0.2);
        }
        .main-btn:hover { background-color: #3367d6; transform: translateY(-2px); }
        .main-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .result-container { display: flex; flex-direction: column; gap: 1.5rem; }
        
        .line-card {
            background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary-color);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .line-japanese {
            font-size: 1.4rem; font-weight: bold; margin-bottom: 6px; line-height: 1.6;
            display: flex; flex-wrap: wrap; gap: 4px; 
        }
        .word-token {
            cursor: pointer; padding: 2px 4px; border-radius: 6px; transition: 0.2s;
            border-bottom: 2px solid transparent;
        }
        .word-token:hover {
            background-color: var(--highlight); color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .line-pronunciation { font-size: 1rem; color: #ea4335; margin-bottom: 8px; font-style: italic; font-weight: 500; }
        .line-translation { color: #555; font-size: 1rem; padding-top: 8px; border-top: 1px dashed #eee; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.active { display: flex; animation: fadeInModal 0.2s; }
        
        .modal-content {
            background: white; width: 90%; max-width: 400px; padding: 2rem; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; position: relative;
            animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        .modal-word { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; color: #333; }
        .modal-reading { font-size: 1.2rem; color: #ea4335; margin-bottom: 1.5rem; font-weight: bold; }
        .modal-meaning-box { background: #f1f3f4; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .modal-meaning { font-size: 1.3rem; color: var(--primary-color); font-weight: bold; margin-bottom: 0.5rem; }
        .modal-detail { font-size: 0.9rem; color: #666; line-height: 1.4; }
        
        .btn-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #aaa; }
        .btn-dict { background: #03C75A; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 0.9rem; display: inline-block; transition: 0.2s; }
        .btn-dict:hover { background: #02a349; transform: translateY(-2px); }

        .loading { text-align: center; display: none; color: #666; margin-top: 1rem; }
        .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(66,133,244,0.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s infinite linear; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <h1>J-Lyric Perfect ğŸ¤</h1>
        <p class="subtitle">ë°œìŒ ë³´ë©° ë…¸ë˜í•˜ê³ , í´ë¦­í•´ì„œ ê³µë¶€í•˜ê³ !</p>
    </header>

    <div class="container">
        <div class="input-box">
            <div class="file-upload-wrapper">
                <span>ğŸ“· ê°€ì‚¬ ìº¡ì²˜ ì—…ë¡œë“œ (í´ë¦­)</span>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
            </div>
            <div id="previewContainer" class="preview-area">
                <img id="imagePreview" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                <button onclick="clearImage()">âŒ ì´ë¯¸ì§€ ì‚­ì œ</button>
            </div>
            <textarea id="lyricInput" placeholder="ì—¬ê¸°ì— ì¼ë³¸ì–´ ê°€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button id="btnTrans" class="main-btn" onclick="startTranslate()">ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div><span>AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ§</span>
        </div>

        <div id="resultContainer" class="result-container"></div>
    </div>

    <div id="learningModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="btn-close" onclick="closeModal()">Ã—</button>
            <div id="mWord" class="modal-word"></div>
            <div id="mReading" class="modal-reading"></div>
            <div class="modal-meaning-box">
                <div id="mMeaning" class="modal-meaning"></div>
                <div id="mDetail" class="modal-detail"></div>
            </div>
            <a id="mDictLink" href="#" target="_blank" class="btn-dict">ë„¤ì´ë²„ ì‚¬ì „ì—ì„œ ë”ë³´ê¸° ğŸ“—</a>
        </div>
    </div>

    <script>
        // ========================================================
        // [Frontend Script]
        // ========================================================

        let selectedImageBase64 = null;
        let selectedImageMimeType = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                selectedImageBase64 = e.target.result.split(',')[1];
                selectedImageMimeType = file.type;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            document.getElementById('imageInput').value = "";
            document.getElementById('previewContainer').style.display = 'none';
            selectedImageBase64 = null;
            selectedImageMimeType = null;
        }

        // [í•µì‹¬] ë²ˆì—­ ì‹œì‘ í•¨ìˆ˜ (ì—¬ê¸° ìˆì–´ì•¼ ë²„íŠ¼ì´ ì‘ë™í•©ë‹ˆë‹¤!)
        async function startTranslate() {
            const lyricText = document.getElementById('lyricInput').value.trim();
            const resultDiv = document.getElementById('resultContainer');
            const loading = document.getElementById('loading');
            const btnTrans = document.getElementById('btnTrans');

            if (!lyricText && !selectedImageBase64) {
                alert("ê°€ì‚¬ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); 
                return;
            }

            resultDiv.innerHTML = "";
            loading.style.display = "block";
            btnTrans.disabled = true;

            try {
                // ë°±ì—”ë“œ í˜¸ì¶œ
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: lyricText,
                        image: selectedImageBase64,
                        mimeType: selectedImageMimeType
                    })
                });

                // [ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”] í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ì•„ì„œ JSONì¸ì§€ í™•ì¸
                const textResponse = await response.text();
                let json;
                
                try {
                    json = JSON.parse(textResponse);
                } catch (e) {
                    // JSONì´ ì•„ë‹ˆë¼ë©´ ì„œë²„ê°€ ì—ëŸ¬ í˜ì´ì§€(HTML/Text)ë¥¼ ë³´ë‚¸ ê²ƒì„
                    console.error("ì„œë²„ ì‘ë‹µ ì›ë³¸:", textResponse);
                    throw new Error("ì„œë²„ ì„¤ì • ì˜¤ë¥˜ì…ë‹ˆë‹¤. (API í‚¤ í™•ì¸ í•„ìš”)\nì„œë²„ ë©”ì‹œì§€: " + textResponse.substring(0, 100));
                }

                if (!response.ok) {
                    throw new Error(json.error || "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                }
                
                // ê²°ê³¼ í™”ë©´ ë Œë”ë§
                json.forEach(line => {
                    const card = document.createElement('div');
                    card.className = 'line-card';

                    const japDiv = document.createElement('div');
                    japDiv.className = 'line-japanese';
                    
                    if (line.tokens && Array.isArray(line.tokens)) {
                        line.tokens.forEach(token => {
                            const span = document.createElement('span');
                            span.className = 'word-token';
                            span.textContent = token.text;
                            span.onclick = function() { openModal(token); };
                            japDiv.appendChild(span);
                        });
                    }

                    const pronDiv = document.createElement('div');
                    pronDiv.className = 'line-pronunciation';
                    pronDiv.textContent = line.fullPronunciation ? `[${line.fullPronunciation}]` : "";

                    const korDiv = document.createElement('div');
                    korDiv.className = 'line-translation';
                    korDiv.textContent = line.lineTranslation;

                    card.appendChild(japDiv);
                    card.appendChild(pronDiv);
                    card.appendChild(korDiv);
                    resultDiv.appendChild(card);
                });

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ:\n" + e.message);
            } finally {
                loading.style.display = "none";
                btnTrans.disabled = false;
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        const modal = document.getElementById('learningModal');
        function openModal(token) {
            if(!modal) return;

            document.getElementById('mWord').textContent = token.text;
            document.getElementById('mReading').textContent = token.reading || "";
            
            // [ìˆ˜ì •ë¨] ëœ»(meaning)ì´ ì—†ìœ¼ë©´ ìƒì„¸ì„¤ëª…(detail)ì´ë¼ë„ ë³´ì—¬ì£¼ê³ , ê·¸ê²ƒë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¬¸êµ¬ ì¶œë ¥
            document.getElementById('mMeaning').textContent = token.meaning || token.detail || "ì‚¬ì „ ê²€ìƒ‰ í•„ìš”";
            
            // ìƒì„¸ì„¤ëª…(detail)ì€ ëœ»ê³¼ ë‹¤ë¥¼ ë•Œë§Œ ë³´ì—¬ì¤Œ
            document.getElementById('mDetail').textContent = (token.meaning && token.detail) ? token.detail : "";
            
            const dictUrl = `https://ja.dict.naver.com/#/search?query=${encodeURIComponent(token.text)}`;
            const dictLink = document.getElementById('mDictLink');
            if(dictLink) dictLink.href = dictUrl;
            
            modal.classList.add('active');
        }
    </script>
</body>
</html>